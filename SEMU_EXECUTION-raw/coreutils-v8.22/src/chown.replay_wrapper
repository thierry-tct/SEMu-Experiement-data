#!/bin/bash

# That's a test replay script;
# It is used when replaying tests with prefix, i.e. following all the commands
# as in the original test case in order to have the same test environment;
# The script is controlled via enviroment variables that are set accordingly
# before executing a test case (the runner script stores the
# necessary state info, which is needed to coordinate the test replaying process).

set -u
set -o pipefail

# TODO: path to 'tee' is hard-coded to avoid problems with binutils

# This script is invoked by the test suite. Don't rely on the wd.
TOOL_DIR="/media/disk2/SEMU-EXPERIMENT/rootteststools/workspace/repos/chown/src"
TOOL_NAME="chown"

## signal handlers
#function term_signal_handler {
#  #echo "handling term signal" >> /tmp/signallog
#  pkill -P "$$"
#}
#function int_signal_handler {
#  #echo "handling int signal" >> /tmp/signallog
#  pkill -P "$$"
#}
#function hup_signal_handler {
#  #echo "handling hup signal" >> /tmp/signallog
#  pkill -P "$$"
#}

argv=`/usr/bin/basename $0`
if [[ ${#@} != 0 ]]
then 
  argv+=" $@"
fi

# critical section
  # FD is redirected to our lock file
  FD=200
  eval "exec ${FD}>$EKLEEPSE_REPLAY_COUNTER_FILE.lock"

  # try to lock the file with timeout of 1s
  /usr/bin/flock -w 60 $FD
  [[ $? -eq 1 ]] && /bin/echo "failed to aquire the lock" >> /tmp/mylog

  # set a default value that will prevent from executing klee-replay
  COUNTER=-1
  
  # check if the argv that the wrapper was called with is the desired argv
  if [[ "$EKLEEPSE_REPLAY_MODE" = 0 || "$argv" = "$EKLEEPSE_REPLAY_ARGV" ]]
  then
    # the current argv is the desired one; now we need to get the value of the
    # counter from the file; the counter establishes an order in case of multiple
    # occurrences of the same argv     

    # first, we need to get the value of the counter from a file
    COUNTER=`/bin/cat "$EKLEEPSE_REPLAY_COUNTER_FILE"`
    # echo "COUNTER = $COUNTER"

    # decrement the counter and store it in the file
    CNT=$((COUNTER - 1))
    /bin/echo "$CNT" > "$EKLEEPSE_REPLAY_COUNTER_FILE"
  fi

  # release the lock
  /usr/bin/flock -u $FD
# end of critical section 


if [[ "$COUNTER" = 0 ]]; then
  if [[ "$argv" != "$EKLEEPSE_RUN_ARGS" ]]
  then
    stamp=`/bin/date +'%Y-%m-%d %H:%M:%S:%N'`
    #/bin/echo "Replay cmd args [$argv] are not the same as run args [$EKLEEPSE_RUN_ARGS] $stamp" >> $EKLEEPSE_REPLAY_LOG
  fi
  
  ## install handlers that will terminate child processes (klee-replay and tee)
  ## note: klee-replay does spawn processes but it also should terminate them
  ## nicely after receiving sigterm
  #trap term_signal_handler SIGTERM 
  #trap int_signal_handler SIGINT
  #trap hup_signal_handler SIGHUP
  
  /usr/bin/touch $EKLEEPSE_REPLAY_ATTEMPT

  #echo "running by klee-replay EKLEEPSE_REPLAY_TOOL=$EKLEEPSE_REPLAY_TOOL, EKLEEPSE_REPLAY_KTEST=$EKLEEPSE_REPLAY_KTEST, EKLEEPSE_REPLAY_LOG=$EKLEEPSE_REPLAY_LOG"
  #note: klee-replay does not return the application return code
  # http://veithen.github.io/2014/11/16/sigterm-propagation.html
  # both: klee-replay and tee are run in bg; both are children of this script; 
  # wait will happen for tee, which is not perfect, but all processes are
  # cleaned up by session in a higher level script
  export KLEE_REPLAY_TIMEOUT=$EKLEEPSE_REPLAY_TIMEOUT
  if [ "${MFIKESTSREPLAY_NATIVEREPLAY:-}" = "1" ]
  then
    #/bin/echo "ARGS: $TOOL_NAME ${@:1}" 2>&1 | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
    /bin/echo "TOOL: $TOOL_NAME" 2>&1 | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
    /usr/bin/timeout -s 9 $KLEE_REPLAY_TIMEOUT $EKLEEPSE_REPLAY_TOOL "${@:1}" 2>&1 | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
    #/usr/bin/timeout $KLEE_REPLAY_TIMEOUT $EKLEEPSE_REPLAY_TOOL "${@:1}" 2>&1 | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
    /bin/echo "RETURN CODE: $?" 2>&1 | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG 
  else
    #klee-replay $EKLEEPSE_REPLAY_TOOL $EKLEEPSE_REPLAY_KTEST 2>&1 | /bin/sed -e 's| ([0-9]\+\s\+seconds)| |g' | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
    klee-replay $EKLEEPSE_REPLAY_TOOL $EKLEEPSE_REPLAY_KTEST 2>&1 | /bin/grep -v -E "^note: (pty|pipe) (master|slave): " | /bin/grep -v -E "^klee-replay: PTY (MASTER|SLAVE): EXIT STATUS: " | /bin/grep -v -E "^warning: check_file .*: .* mismatch: [0-9]+ [vV][sS] [0-9]+$" | /bin/sed -e 's| ([0-9]\+\s\+seconds)| |g; s|RUNNING GDB: /usr/bin/gdb --pid [0-9]\+ -q --batch|RUNNING GDB: /usr/bin/gdb --pid PID -q --batch|g' | /usr/bin/tee -a $EKLEEPSE_REPLAY_LOG
  fi
  #pid=$!
  #wait $pid
  #wait $pid
else
  # run natively
  #echo "running natively EKLEEPSE_REPLAY_TOOL=$EKLEEPSE_REPLAY_TOOL"
  exec /usr/bin/timeout -s 9 $EKLEEPSE_REPLAY_TIMEOUT $EKLEEPSE_REPLAY_TOOL_NO_INSTRUMENT "${@:1}"
  #exec /usr/bin/timeout $EKLEEPSE_REPLAY_TIMEOUT $EKLEEPSE_REPLAY_TOOL_NO_INSTRUMENT "${@:1}"
fi 


